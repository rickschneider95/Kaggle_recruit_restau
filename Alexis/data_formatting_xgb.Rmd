---
title: "format_data_xgb"
author: "Alexis Laks"
date: "29/11/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(dplyr)
library(onehot)
library(data.table)
library(mltools)
library(dplyr)
library(stringr)
library(lubridate)
```

This file will be dedicated to formatting the complete_data.csv file to feed to the xgb model.


<<<<<<< HEAD
```{r}
data <- read.csv("data/complete_data.csv")
data
View(data)
data %>% glimpse
```
=======
# Keeping only hpg <-> air and air:
>>>>>>> Feature-engineering

```{r}
dataset <- read.csv("data/complete_data.csv")
```


```{r}
data_air <- dataset %>% filter(str_detect(id, "^air"))
```

```{r}
data_hpg <- data %>% filter(str_detect(id, "^hpg"))
```


# for rick
```{r}
sum(is.na(data_air %>% group_by(id,visit_date) %>% summarise(total = n())))
```


# Filtering NIGHT or DAY :

```{r}
data_air
ifelse(5==5,"yes","no")

n_d <- function(data,period){
  try <- data
  try <- try %>%
    mutate(visit_time = as.numeric(str_sub(as.character(visit_time)é, start = 0, end = 3)))
    ifelse(as.character(period) == "noon",
    data <- data %>% filter(visit_time <= 16 && visit_time >= 4),
    data <- data %>% filter(visit_time >= 16 && visit_time <= 4)
    )
}
try <- data_air
n_d(try,"noon")
```


# One hot encoding for VISIT time:

```{r}
vtime_transf <- function(data){
  one_h <- data
  one_h$visit_time <- as.factor(str_sub(as.character(one_h$visit_time), start = 0, end = 3)) #put visit_time as factor, and only extract the hour for the time: the first two components of the time: ex 19:00:00 will be converted to 19
  one_h <- one_h %>% select(visit_time)
  one_h <- one_hot(as.data.table(one_h))
  data <- data %>% cbind(one_h)
}
```

# One hot encoding for RESERVE time:

```{r}
rtime_transf <- function(data){
  one_h <- data
  one_h$reserve_time <- as.factor(str_sub(as.character(one_h$reserve_time), start = 0, end = 3))
  one_h <- one_h %>% select(reserve_time)
  one_h <- one_hot(as.data.table(one_h))
  data <- data %>% cbind(one_h)
}
```

# One hot encoding for reserve MONTH:

```{r}
rmonth_transf <- function(data){
  one_h <- data
  one_h$reserve_date <- as.factor(str_sub(as.character(one_h$reserve_date), start = 6, end = 7))
  one_h <- one_h %>% select(reserve_date)
  one_h <- one_hot(as.data.table(one_h))
  data <- data %>% cbind(one_h)
}

```

# LOOOUUUUUIIIISSSSS
```{r}
data <- data %>%
  mutate(day_visit = day(dmy(visit_date)), #extract visit day from date
         day_reserve = day(dmy(reserve_date)),  #extract reserve day from date
         month_visit = month(dmy(visit_date)),   #extract visit month from date
         month_reserve = month(dmy(reserve_date)), #extract reserve month from date
         year_visit = year(dmy(visit_date)), #extract visit year from date
         year_reserve = year(dmy(visit_date)), #extract reserve year from date
         latency_days=ifelse(is.na(reserve_date),0,as.numeric(as.Date(visit_date)-as.Date(reserve_date))), #days between reservation vs visit. if no reservation then will be 0
         latency_people=ifelse(is.na(reserve_visitors),0,visitors-reserve_visitors)) #difference in the number of people from the party between reservation vs visit. if no reservation then will be 0
```

# One hot encoding for visit MONTH:

```{r}
vmonth_transf <- function(data){
  one_h <- data
  one_h$visit_date <- as.factor(str_sub(as.character(one_h$visit_date), start = 6, end = 7))
  one_h <- one_h %>% select(visit_date)
  one_h <- one_hot(as.data.table(one_h))
  data <- data %>% cbind(one_h)
}

```

# One hot encoding for reserve YEAR:

```{r}
ryear_transf <- function(data){
  one_h <- data
  one_h$reserve_date <- as.factor(str_sub(as.character(one_h$reserve_date), start = 0, end = 4))
  one_h <- one_h %>% select(reserve_date)
  one_h <- one_hot(as.data.table(one_h))
  data <- data %>% cbind(one_h)
}
```

# One hot encoding for visit YEAR:

```{r}
vyear_transf <- function(data){
  one_h <- data
  one_h$visit_date <- as.factor(str_sub(as.character(one_h$visit_date), start = 0, end = 4))
  one_h <- one_h %>% select(visit_date)
  one_h <- one_hot(as.data.table(one_h))
  data <- data %>% cbind(one_h)
}
```

# One hot encoding AREA:

There are many different levels for area names, although they all appartain to one particular city. In addition the longitude and latitudes are approximate (on for each area not for each id). I propose to solve this

```{r}
area_transf <- function(data){
  one_h <- data
  one_h <- one_h %>%
    select(area_name) %>%
    mutate(area_name = as.character(area_name)) %>%
    mutate(area_name = case_when(area_name == "Osaka Prefecture Osaka None" ~ "Ōsaka-fu Prefecture Osaka None",
                   TRUE ~ area_name)) %>%
    mutate(area_name = as.factor(substr(area_name, 0, 8)))
  one_h <- one_hot(as.data.table(one_h))
  try <- data %>% cbind(one_h)
}
```

# One hot encoding for day of week visit
```{r}
#day of week visit et reserve: onehotencoding
names(data)
vdayweek_transf <- function(data){
  one_h <- data
  one_h$day_of_the_week_visit <- as.factor(one_h$day_of_the_week_visit)
  one_h <- one_h %>% select(day_of_the_week_visit)
  one_h <- one_hot(as.data.table(one_h))
  data <- data %>% cbind(one_h)
}
```

# One hot encoding for day of week reserve
```{r}
rdayweek_transf <- function(data){
  one_h <- data
  one_h$day_of_the_week_reserve <- as.factor(one_h$day_of_the_week_visit)
  one_h <- one_h %>% select(day_of_the_week_visit)
  one_h <- one_hot(as.data.table(one_h))
  data <- data %>% cbind(one_h)
}
```

replace reservation times by average diff in res/visit for each ID !!!
group_by id,date and summarise -> get the total number of visits per day. (per noon,night?) => solution: seperate data set in visits for noon/ visits for ngiht and run xgb on each separately

# TRY CHUNK ( TRY MY CHUNK (:^<) )

```{r}
try <- data_air
try <- rtime_transf(try)
try <- vtime_transf(try)
try <- rmonth_transf(try)
try <- vmonth_transf(try)
try <- ryear_transf(try)
try <- vyear_transf(try)
try <- area_transf(try)


try
```


We have NA's for day of the week reserve and day of the week visit
```{r}
sum(is.na(data$day_of_the_week_reserve))
sum(is.na(data$day_of_the_week_visit))
```
